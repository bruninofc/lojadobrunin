// UltimaxStoreFirebase.jsx
import React, { useEffect, useState } from "react";

/*
  COLOQUE SUA CONFIGURAÇÃO FIREBASE ABAIXO
  (copie do console.firebase.google.com)
*/
import { initializeApp } from "firebase/app";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
} from "firebase/auth";
import {
  getFirestore,
  collection,
  doc,
  setDoc,
  getDoc,
  addDoc,
  onSnapshot,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
} from "firebase/firestore";
import { getStorage, ref as sRef, uploadString, getDownloadURL } from "firebase/storage";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MSG_SENDER_ID",
  appId: "YOUR_APP_ID",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);
const storage = getStorage(app);

// Configurações da loja
const ADMIN_EMAIL = "ultimaxadm@gmail.com";
const WHATSAPP_FULL_NUMBER = "5598984658374"; // ← Número corrigido (sem espaços)
const DISCORD_INVITE = "https://discord.gg/u3SQ54ZP"; // ← Sem espaço no final

export default function UltimaxStoreFirebase() {
  const [user, setUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [loadingAuth, setLoadingAuth] = useState(true);
  const [notification, setNotification] = useState(""); // para mensagens amigáveis

  const [primaryColor, setPrimaryColor] = useState("#0ea5e9");
  const [bgColor, setBgColor] = useState("#000000");
  const [textColor, setTextColor] = useState("#ffffff");

  const [products, setProducts] = useState([]);
  const [queryText, setQueryText] = useState("");
  const [platformBalance, setPlatformBalance] = useState(0);

  // Limpa notificação após 3s
  useEffect(() => {
    if (notification) {
      const t = setTimeout(() => setNotification(""), 3000);
      return () => clearTimeout(t);
    }
  }, [notification]);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (u) => {
      setUser(u);
      if (u) {
        const userDoc = doc(db, "users", u.uid);
        const snap = await getDoc(userDoc);
        if (snap.exists()) {
          const data = snap.data();
          setIsAdmin(!!data?.role && data.role === "admin");
        } else {
          const role = u.email === ADMIN_EMAIL ? "admin" : "user";
          await setDoc(userDoc, { email: u.email, role, displayName: u.displayName || null });
          setIsAdmin(role === "admin");
        }
      } else {
        setIsAdmin(false);
      }
      setLoadingAuth(false);
    });
    return () => unsub();
  }, []);

  // realtime products
  useEffect(() => {
    const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
    const unsub = onSnapshot(q, (snap) => {
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setProducts(arr);
    });
    return () => unsub();
  }, []);

  // platform balance
  useEffect(() => {
    const pDoc = doc(db, "platform", "balance");
    const unsub = onSnapshot(pDoc, (snap) => {
      if (snap.exists()) setPlatformBalance(snap.data().amount || 0);
      else setPlatformBalance(0);
    });
    return () => unsub();
  }, []);

  // Auth helpers
  async function signInWithGoogle() {
    try {
      await signInWithPopup(auth, provider);
    } catch (e) {
      setNotification("Erro Google: " + (e.message || "tente novamente"));
    }
  }

  async function registerWithEmail(email, password, displayName = "") {
    if (!email || !password) return setNotification("Preencha e-mail e senha");
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      if (cred.user) {
        const userDoc = doc(db, "users", cred.user.uid);
        const role = email === ADMIN_EMAIL ? "admin" : "user";
        await setDoc(userDoc, { email, displayName, role });
        setNotification("Conta criada com sucesso!");
      }
    } catch (e) {
      setNotification("Erro registro: " + (e.message || "tente novamente"));
    }
  }

  async function loginWithEmail(email, password) {
    if (!email || !password) return setNotification("Preencha e-mail e senha");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      setNotification("Erro login: " + (e.message || "credenciais inválidas"));
    }
  }

  async function logout() {
    try {
      await signOut(auth);
    } catch (e) {
      setNotification("Erro ao sair");
    }
  }

  // Product CRUD
  async function createProduct(prod) {
    if (!isAdmin) return setNotification("Somente admins");
    if (!prod.title?.trim()) return setNotification("Título é obrigatório");
    await addDoc(collection(db, "products"), { ...prod, createdAt: new Date() });
    setNotification("Produto criado!");
  }

  async function updateProduct(id, patch) {
    if (!isAdmin) return setNotification("Somente admins");
    await updateDoc(doc(db, "products", id), patch);
  }

  async function deleteProduct(id) {
    if (!isAdmin) return setNotification("Somente admins");
    await deleteDoc(doc(db, "products", id));
    setNotification("Produto excluído");
  }

  // Buy flow
  async function buyProduct(product) {
    if (!user) return setNotification("Faça login para comprar");
    if (product.stock <= 0) return setNotification("Produto esgotado");
    try {
      const pRef = doc(db, "products", product.id);
      await updateDoc(pRef, { stock: product.stock - 1 });

      const pDoc = doc(db, "platform", "balance");
      const snap = await getDoc(pDoc);
      const current = snap.exists() ? (snap.data().amount || 0) : 0;
      await setDoc(pDoc, { amount: +(current + Number(product.price)).toFixed(2) });

      await addDoc(collection(db, "orders"), {
        productId: product.id,
        productTitle: product.title,
        amount: Number(product.price),
        buyerUid: user.uid,
        buyerEmail: user.email,
        status: "paid",
        createdAt: new Date(),
      });

      setNotification("Compra registrada! Abrindo WhatsApp...");
      window.open(
        `https://wa.me/${WHATSAPP_FULL_NUMBER}?text=${encodeURIComponent(
          `Olá, confirmei a compra do produto: ${product.title}`
        )}`,
        "_blank"
      );
    } catch (e) {
      setNotification("Erro na compra: " + (e.message || "tente novamente"));
    }
  }

  // Withdraw (admin)
  async function withdrawToPix(pixKey) {
    if (!isAdmin) return setNotification("Somente admins");
    if (!pixKey?.trim()) return setNotification("Informe uma chave PIX");
    const pDoc = doc(db, "platform", "balance");
    const snap = await getDoc(pDoc);
    const amount = snap.exists() ? (snap.data().amount || 0) : 0;
    if (!amount || amount <= 0) return setNotification("Sem saldo disponível");
    await addDoc(collection(db, "withdraws"), {
      to: pixKey.trim(),
      amount,
      createdAt: new Date(),
      by: user.email,
    });
    await setDoc(pDoc, { amount: 0 });
    setNotification("Retirada registrada (simulada).");
  }

  // Upload image
  async function uploadImageFile(file) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const dataUrl = e.target.result;
          const key = `products/${Date.now()}_${file.name}`;
          const ref = sRef(storage, key);
          await uploadString(ref, dataUrl, "data_url");
          const url = await getDownloadURL(ref);
          res(url);
        } catch (err) {
          rej(err);
        }
      };
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
  }

  async function rateProduct(productId, rating) {
    if (!user) return setNotification("Faça login para avaliar");
    try {
      await addDoc(collection(db, `products/${productId}/ratings`), {
        rating,
        by: user.uid,
        createdAt: new Date(),
      });
      setNotification("Obrigado pela avaliação!");
    } catch (e) {
      setNotification("Erro ao avaliar");
    }
  }

  const filtered = products.filter(p =>
    (p.title + " " + (p.subtitle || "") + " " + (p.description || ""))
      .toLowerCase()
      .includes(queryText.toLowerCase())
  );

  if (loadingAuth) return <div className="p-6">Carregando autenticação...</div>;

  return (
    <div style={{ background: bgColor, color: textColor, minHeight: "100vh" }} className="p-4">
      {/* Notificação flutuante */}
      {notification && (
        <div
          style={{
            position: "fixed",
            top: "20px",
            right: "20px",
            background: "#111827",
            color: "#fff",
            padding: "12px 20px",
            borderRadius: "8px",
            zIndex: 1000,
            boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
          }}
        >
          {notification}
        </div>
      )}

      <div className="max-w-6xl mx-auto">
        <header className="flex items-center justify-between mb-6">
          <h1 className="text-2xl font-bold" style={{ color: primaryColor }}>
            Ultimax Store
          </h1>
          <div className="flex items-center gap-3">
            <input
              value={queryText}
              onChange={(e) => setQueryText(e.target.value)}
              placeholder="Pesquisar produtos..."
              className="px-3 py-2 rounded bg-gray-800 text-white"
            />
            {user ? (
              <div className="flex items-center gap-2">
                <div className="text-sm">
                  {user.email} {isAdmin && <strong>(Admin)</strong>}
                </div>
                <button onClick={logout} className="px-3 py-2 rounded border border-gray-600">
                  Logout
                </button>
              </div>
            ) : (
              <div className="flex items-center gap-2">
                <button
                  onClick={signInWithGoogle}
                  className="px-3 py-2 rounded"
                  style={{ background: primaryColor }}
                >
                  Entrar com Google
                </button>
                <button
                  onClick={() => {
                    const email = prompt("Email");
                    const pass = prompt("Senha");
                    if (email && pass) loginWithEmail(email, pass);
                  }}
                  className="px-3 py-2 rounded border border-gray-600"
                >
                  Entrar (E-mail)
                </button>
              </div>
            )}
          </div>
        </header>

        <main className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filtered.map((p) => (
            <div
              key={p.id}
              className="rounded-lg p-4 shadow-lg"
              style={{ background: "#0b1220" }}
            >
              <div className="h-40 flex items-center justify-center">
                {p.image ? (
                  <img src={p.image} alt={p.title} className="object-contain h-full" />
                ) : (
                  <div className="text-sm opacity-70">Sem imagem</div>
                )}
              </div>
              <h2 className="mt-2 font-semibold text-lg">{p.title}</h2>
              <div className="text-sm opacity-80">{p.subtitle}</div>
              <div className="mt-1 font-bold">R$ {Number(p.price).toFixed(2)}</div>
              <div className="flex items-center gap-2 mt-2">
                <button
                  onClick={() => buyProduct(p)}
                  className="px-3 py-2 rounded"
                  style={{ background: primaryColor }}
                >
                  Comprar
                </button>
                <button
                  onClick={() =>
                    window.open(
                      `https://wa.me/${WHATSAPP_FULL_NUMBER}?text=${encodeURIComponent(
                        `Quero pegar meu pedido: ${p.title}`
                      )}`,
                      "_blank"
                    )
                  }
                  className="px-3 py-2 rounded border border-gray-600"
                >
                  Pega meu pedido (WhatsApp)
                </button>
                <button
                  onClick={() => window.open(DISCORD_INVITE, "_blank")}
                  className="px-3 py-2 rounded border border-gray-600"
                >
                  Pega meu pedido (Discord)
                </button>
              </div>
              <div className="mt-2 flex items-center justify-between text-sm">
                <div>Estoque: {p.stock}</div>
                <div>Avaliação: {p.rating || "—"}</div>
              </div>
              <div className="mt-2 flex items-center gap-2">
                <label className="text-xs">Avaliar:</label>
                {[1, 2, 3, 4, 5].map((n) => (
                  <button
                    key={n}
                    onClick={() => rateProduct(p.id, n)}
                    className="px-2 py-1 rounded text-xs bg-gray-700 hover:bg-gray-600"
                  >
                    {n}★
                  </button>
                ))}
              </div>

              {isAdmin && (
                <div className="mt-3 flex gap-2">
                  <button
                    onClick={async () => {
                      const title = prompt("Título", p.title);
                      if (title?.trim()) await updateProduct(p.id, { title });
                    }}
                    className="px-3 py-2 rounded border border-gray-600"
                  >
                    Editar
                  </button>
                  <button
                    onClick={() => deleteProduct(p.id)}
                    className="px-3 py-2 rounded border border-red-600 text-red-400"
                  >
                    Excluir
                  </button>
                </div>
              )}
            </div>
          ))}
        </main>

        {isAdmin && (
          <aside
            className="fixed bottom-4 right-4 bg-gray-900 p-4 rounded shadow-lg w-80"
            style={{ border: "1px solid #333" }}
          >
            <h3 className="font-semibold">Painel Admin</h3>
            <div className="mt-2">
              Cofre da plataforma: <strong>R$ {Number(platformBalance).toFixed(2)}</strong>
            </div>
            <div className="mt-2">
              Tema:{" "}
              <input
                value={primaryColor}
                onChange={(e) => setPrimaryColor(e.target.value)}
                type="color"
                className="ml-2 w-8 h-6 cursor-pointer"
              />
            </div>
            <div className="mt-2">
              Fundo:{" "}
              <input
                value={bgColor}
                onChange={(e) => setBgColor(e.target.value)}
                type="color"
                className="ml-2 w-8 h-6 cursor-pointer"
              />
            </div>
            <div className="mt-2 flex gap-2">
              <button
                onClick={() => setNotification("Salvar tema: implemente em Firestore")}
                className="px-2 py-1 rounded bg-blue-600 text-white text-xs"
              >
                Salvar tema
              </button>
              <button
                onClick={() => setNotification("Atualizado via Firestore (real-time)!")}
                className="px-2 py-1 rounded border border-gray-600 text-xs"
              >
                Atualizar
              </button>
            </div>

            <div className="mt-3">
              <h4 className="font-semibold text-sm">Criar Produto</h4>
              <CreateProductForm onCreate={createProduct} onUploadImage={uploadImageFile} />
            </div>

            <div className="mt-3">
              <h4 className="font-semibold text-sm">Retirar PIX</h4>
              <div className="flex gap-2 mt-2">
                <input
                  id="pixkey"
                  placeholder="chave PIX"
                  className="px-2 py-1 rounded bg-gray-800 text-white flex-1 text-sm"
                />
                <button
                  onClick={() => {
                    const key = document.getElementById("pixkey")?.value;
                    withdrawToPix(key);
                  }}
                  className="px-2 py-1 rounded bg-green-600 text-white text-xs"
                >
                  Retirar
                </button>
              </div>
            </div>
          </aside>
        )}
      </div>
    </div>
  );
}

function CreateProductForm({ onCreate, onUploadImage }) {
  const [title, setTitle] = useState("");
  const [subtitle, setSubtitle] = useState("");
  const [price, setPrice] = useState(0);
  const [stock, setStock] = useState(1);
  const [desc, setDesc] = useState("");
  const [imageUrl, setImageUrl] = useState("");

  const handleSubmit = () => {
    if (!title.trim()) return alert("Título é obrigatório");
    onCreate({
      title,
      subtitle,
      price: Number(price) || 0,
      stock: Number(stock) || 0,
      description: desc,
      image: imageUrl,
    });
    setTitle("");
    setSubtitle("");
    setPrice(0);
    setStock(1);
    setDesc("");
    setImageUrl("");
  };

  return (
    <div className="space-y-2 text-sm">
      <input
        value={title}
        onChange={(e) => setTitle(e.target.value)}
        placeholder="Título *"
        className="w-full px-2 py-1 rounded bg-gray-800 text-white"
      />
      <input
        value={subtitle}
        onChange={(e) => setSubtitle(e.target.value)}
        placeholder="Subtítulo"
        className="w-full px-2 py-1 rounded bg-gray-800 text-white"
      />
      <div className="flex gap-2">
        <input
          value={price}
          onChange={(e) => setPrice(e.target.value)}
          placeholder="Preço"
          type="number"
          step="0.01"
          className="px-2 py-1 rounded bg-gray-800 text-white"
        />
        <input
          value={stock}
          onChange={(e) => setStock(e.target.value)}
          placeholder="Estoque"
          type="number"
          className="px-2 py-1 rounded bg-gray-800 text-white"
        />
      </div>
      <textarea
        value={desc}
        onChange={(e) => setDesc(e.target.value)}
        placeholder="Descrição"
        className="w-full px-2 py-1 rounded bg-gray-800 text-white"
        rows="2"
      />
      <div>
        <input
          type="file"
          accept="image/*"
          onChange={async (e) => {
            const f = e.target.files?.[0];
            if (!f) return;
            try {
              const url = await onUploadImage(f);
              setImageUrl(url);
            } catch (err) {
              alert("Erro ao fazer upload da imagem");
            }
          }}
        />
        {imageUrl && <img src={imageUrl} alt="preview" className="h-24 mt-2 object-contain" />}
      </div>
      <button
        onClick={handleSubmit}
        className="px-3 py-2 rounded bg-blue-500 text-white text-sm"
      >
        Criar Produto
      </button>
    </div>
  );
}
